#!/usr/bin/env ruby

require File.join(File.dirname(__FILE__), 'document-cache' )
require File.join(File.dirname(__FILE__), 'vocabulary-chest' )
require 'rubygems'
require 'amatch'

def pick_choices_for word, words
	others = words.reject{|w| w == word}
	choices = (others.shuffle[0,4] + [word])
	choices.shuffle
end

@failures = 0
@turn = 0
def hit_rate
	rate = 100 - @failures / @turn.to_f * 100
	rate > 0 ? rate : 0
end

def deumlaut w
	w.gsub("ä", "ae").gsub("ö", "oe").gsub("ü", "ue")
end

def same one, other
	Amatch::Levenshtein.new(deumlaut(one)).match(deumlaut(other)) <= 1
end

def play words
	words.shuffle.each{|word|
		matches = DocumentCache.find_examples_for(word, 10)
		if matches.empty?
			puts "Sorry. We do not find an example for: #{word}."
			next
		end
		match = matches.sort{|a, b| a.size <=> b.size}.first
		stemmed_match = VocabularyChest::stem(word)
		sentence_tokens = match.split(" ").map{|w| if VocabularyChest::stem(w) == stemmed_match; "______"; else; w; end}

		puts
		puts "------------------------------------------------------------"
		puts "Hit rate: #{'%i' % hit_rate}%"
		puts "------------------------------------------------------------"
		puts
		puts sentence_tokens.join(" ")
		puts 
		puts "Choices: [ #{pick_choices_for(word, words).join(" - ")} ]"
		puts

		STDOUT.write("> ")
		answer = STDIN.gets.chomp
		while answer != '?' and not same(answer, word)
			@failures += 1
			puts "Nope. Try again."
			STDOUT.write("> ")
			answer = STDIN.gets.chomp
		end

		if answer == '?'
			@failures += 1
			puts
			puts "The answer was: #{word}."
			sleep 1
		end

		yield
		@turn += 1
	}
end

def get_input
	if !ARGV.empty?
		File.open(ARGV[0]){|f| f.read}
	else
		STDIN.read
	end
end

input = get_input
words = input.split("\n")
play(words){
	if @turn > words.size and (hit_rate > 95)
		puts "Congratulations. Here is a star for you: *"
		exit(0)
	end
} while true
